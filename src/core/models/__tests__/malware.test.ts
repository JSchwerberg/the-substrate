/**
 * Tests for Malware model functions
 */

import { describe, it, expect, beforeEach } from 'vitest'
import {
  createMalware,
  isMalwareAlive,
  getMalwareHealthPercent,
  applyDamageToMalware,
  activateMalware,
  tickMalwareCooldown,
  canUseAbility,
  useAbility,
  MALWARE_TYPES,
  type Malware,
} from '../malware'

describe('Malware Model', () => {
  describe('createMalware', () => {
    it('should create a worm with correct stats', () => {
      const malware = createMalware('worm', { x: 5, y: 3 })

      expect(malware.type).toBe('worm')
      expect(malware.position).toEqual({ x: 5, y: 3 })
      expect(malware.stats.maxHealth).toBe(MALWARE_TYPES.worm.baseStats.maxHealth)
      expect(malware.stats.health).toBe(MALWARE_TYPES.worm.baseStats.maxHealth)
      expect(malware.status).toBe('active')
      expect(malware.isRevealed).toBe(true) // Worms start revealed
    })

    it('should create a trojan that starts dormant and hidden', () => {
      const malware = createMalware('trojan', { x: 0, y: 0 })

      expect(malware.type).toBe('trojan')
      expect(malware.status).toBe('dormant')
      expect(malware.isRevealed).toBe(false)
    })

    it('should create a rootkit that is stationary', () => {
      const malware = createMalware('rootkit', { x: 2, y: 2 })

      expect(malware.type).toBe('rootkit')
      expect(malware.stats.speed).toBe(0)
    })

    it('should create a logic_bomb', () => {
      const malware = createMalware('logic_bomb', { x: 1, y: 1 })

      expect(malware.type).toBe('logic_bomb')
      expect(malware.status).toBe('dormant')
    })

    it('should assign unique IDs', () => {
      const m1 = createMalware('worm', { x: 0, y: 0 })
      const m2 = createMalware('worm', { x: 1, y: 1 })

      expect(m1.id).not.toBe(m2.id)
    })

    it('should initialize ability cooldown to 0', () => {
      const malware = createMalware('worm', { x: 0, y: 0 })

      expect(malware.abilityCooldown).toBe(0)
    })

    it('should set correct color from definition', () => {
      const worm = createMalware('worm', { x: 0, y: 0 })
      const trojan = createMalware('trojan', { x: 0, y: 0 })

      expect(worm.color).toBe(MALWARE_TYPES.worm.color)
      expect(trojan.color).toBe(MALWARE_TYPES.trojan.color)
    })
  })

  describe('isMalwareAlive', () => {
    let malware: Malware

    beforeEach(() => {
      malware = createMalware('worm', { x: 0, y: 0 })
    })

    it('should return true for healthy malware', () => {
      expect(isMalwareAlive(malware)).toBe(true)
    })

    it('should return true for damaged but living malware', () => {
      malware.stats.health = 1
      expect(isMalwareAlive(malware)).toBe(true)
    })

    it('should return false for malware with 0 health', () => {
      malware.stats.health = 0
      expect(isMalwareAlive(malware)).toBe(false)
    })

    it('should return false for destroyed malware', () => {
      malware.status = 'destroyed'
      expect(isMalwareAlive(malware)).toBe(false)
    })
  })

  describe('getMalwareHealthPercent', () => {
    it('should return 100 for full health', () => {
      const malware = createMalware('worm', { x: 0, y: 0 })
      expect(getMalwareHealthPercent(malware)).toBe(100)
    })

    it('should return 50 for half health', () => {
      const malware = createMalware('worm', { x: 0, y: 0 })
      malware.stats.health = malware.stats.maxHealth / 2
      expect(getMalwareHealthPercent(malware)).toBe(50)
    })

    it('should return 0 for no health', () => {
      const malware = createMalware('worm', { x: 0, y: 0 })
      malware.stats.health = 0
      expect(getMalwareHealthPercent(malware)).toBe(0)
    })
  })

  describe('applyDamageToMalware', () => {
    it('should reduce health by damage minus defense', () => {
      const malware = createMalware('worm', { x: 0, y: 0 })
      const initialHealth = malware.stats.health
      const damage = 20

      const actualDamage = applyDamageToMalware(malware, damage)

      const expectedDamage = Math.max(0, damage - malware.stats.defense)
      expect(actualDamage).toBe(expectedDamage)
      expect(malware.stats.health).toBe(initialHealth - expectedDamage)
    })

    it('should not reduce health below 0', () => {
      const malware = createMalware('worm', { x: 0, y: 0 })

      applyDamageToMalware(malware, 9999)

      expect(malware.stats.health).toBe(0)
    })

    it('should set status to destroyed when health reaches 0', () => {
      const malware = createMalware('worm', { x: 0, y: 0 })

      applyDamageToMalware(malware, 9999)

      expect(malware.status).toBe('destroyed')
    })

    it('should handle high defense reducing damage to 0', () => {
      const malware = createMalware('rootkit', { x: 0, y: 0 }) // Has higher defense
      const lowDamage = 1

      const actualDamage = applyDamageToMalware(malware, lowDamage)

      // If defense >= damage, actual damage should be 0
      if (malware.stats.defense >= lowDamage) {
        expect(actualDamage).toBe(0)
      }
    })
  })

  describe('activateMalware', () => {
    it('should change dormant malware to alerted', () => {
      const malware = createMalware('trojan', { x: 0, y: 0 })
      expect(malware.status).toBe('dormant')

      activateMalware(malware)

      expect(malware.status).toBe('alerted')
    })

    it('should reveal the malware', () => {
      const malware = createMalware('trojan', { x: 0, y: 0 })
      expect(malware.isRevealed).toBe(false)

      activateMalware(malware)

      expect(malware.isRevealed).toBe(true)
    })

    it('should work on already revealed malware', () => {
      const malware = createMalware('worm', { x: 0, y: 0 })
      malware.status = 'dormant'

      activateMalware(malware)

      expect(malware.status).toBe('alerted')
      expect(malware.isRevealed).toBe(true)
    })
  })

  describe('tickMalwareCooldown', () => {
    it('should decrement cooldown when greater than 0', () => {
      const malware = createMalware('worm', { x: 0, y: 0 })
      malware.abilityCooldown = 5

      tickMalwareCooldown(malware)

      expect(malware.abilityCooldown).toBe(4)
    })

    it('should not go below 0', () => {
      const malware = createMalware('worm', { x: 0, y: 0 })
      malware.abilityCooldown = 0

      tickMalwareCooldown(malware)

      expect(malware.abilityCooldown).toBe(0)
    })

    it('should decrement to 0 from 1', () => {
      const malware = createMalware('worm', { x: 0, y: 0 })
      malware.abilityCooldown = 1

      tickMalwareCooldown(malware)

      expect(malware.abilityCooldown).toBe(0)
    })
  })

  describe('canUseAbility', () => {
    it('should return true when cooldown is 0 and alive', () => {
      const malware = createMalware('worm', { x: 0, y: 0 })
      malware.abilityCooldown = 0
      malware.status = 'active'

      expect(canUseAbility(malware)).toBe(true)
    })

    it('should return false when cooldown is not 0', () => {
      const malware = createMalware('worm', { x: 0, y: 0 })
      malware.abilityCooldown = 3

      expect(canUseAbility(malware)).toBe(false)
    })

    it('should return false when malware is destroyed', () => {
      const malware = createMalware('worm', { x: 0, y: 0 })
      malware.abilityCooldown = 0
      malware.status = 'destroyed'

      expect(canUseAbility(malware)).toBe(false)
    })

    it('should return false for malware with no special ability', () => {
      const malware = createMalware('worm', { x: 0, y: 0 })
      malware.abilityCooldown = 0
      malware.behavior.specialAbility = null

      expect(canUseAbility(malware)).toBe(false)
    })
  })

  describe('useAbility', () => {
    it('should set cooldown from behavior special ability', () => {
      const malware = createMalware('worm', { x: 0, y: 0 })
      malware.abilityCooldown = 0

      useAbility(malware)

      const expectedCooldown = MALWARE_TYPES.worm.behavior.specialAbility?.cooldown ?? 0
      expect(malware.abilityCooldown).toBe(expectedCooldown)
    })

    it('should work for different malware types', () => {
      const rootkit = createMalware('rootkit', { x: 0, y: 0 })
      rootkit.status = 'active'
      rootkit.abilityCooldown = 0

      useAbility(rootkit)

      const expectedCooldown = MALWARE_TYPES.rootkit.behavior.specialAbility?.cooldown ?? 0
      expect(rootkit.abilityCooldown).toBe(expectedCooldown)
    })
  })

  describe('MALWARE_TYPES', () => {
    it('should have worm type defined', () => {
      expect(MALWARE_TYPES.worm).toBeDefined()
      expect(MALWARE_TYPES.worm.name).toBe('Worm')
      expect(MALWARE_TYPES.worm.baseStats.speed).toBeGreaterThan(0)
    })

    it('should have trojan type defined', () => {
      expect(MALWARE_TYPES.trojan).toBeDefined()
      expect(MALWARE_TYPES.trojan.name).toBe('Trojan')
      // Trojan starts dormant (handled in createMalware)
    })

    it('should have rootkit type defined', () => {
      expect(MALWARE_TYPES.rootkit).toBeDefined()
      expect(MALWARE_TYPES.rootkit.name).toBe('Rootkit')
      expect(MALWARE_TYPES.rootkit.baseStats.speed).toBe(0) // Stationary
    })

    it('should have logic_bomb type defined', () => {
      expect(MALWARE_TYPES.logic_bomb).toBeDefined()
      expect(MALWARE_TYPES.logic_bomb.name).toBe('Logic Bomb')
      // Logic bomb starts dormant (handled in createMalware)
    })

    it('should have all malware with valid health values', () => {
      for (const def of Object.values(MALWARE_TYPES)) {
        expect(def.baseStats.maxHealth).toBeGreaterThan(0)
        expect(def.baseStats.attack).toBeGreaterThanOrEqual(0)
        expect(def.baseStats.defense).toBeGreaterThanOrEqual(0)
      }
    })
  })
})
