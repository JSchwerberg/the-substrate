/**
 * Malware entity data models
 */

import { GridPosition } from './grid'

// ============= Types =============

export type MalwareType = 'worm' | 'trojan' | 'rootkit' | 'logic_bomb'

export interface MalwareDefinition {
  name: string
  description: string
  baseStats: MalwareBaseStats
  behavior: MalwareBehaviorConfig
  color: number
  shape: 'square' | 'triangle' | 'diamond' | 'hexagon'
}

export interface MalwareBaseStats {
  maxHealth: number
  attack: number
  defense: number
  speed: number // 0 = stationary
}

export interface MalwareBehaviorConfig {
  aggroRange: number
  preferredTarget: 'nearest' | 'weakest' | 'strongest' | 'random'
  fleeHealthPercent: number // Flee when health below this %
  specialAbility: SpecialAbility | null
}

export interface SpecialAbility {
  name: string
  cooldown: number
  effect: 'replicate' | 'corrupt_tile' | 'stealth' | 'explode' | 'entangle'
  value: number
}

// ============= Definitions =============

export const MALWARE_TYPES: Record<MalwareType, MalwareDefinition> = {
  worm: {
    name: 'Worm',
    description: 'Spreads and multiplies; weak individually',
    baseStats: {
      maxHealth: 30,
      attack: 5,
      defense: 2,
      speed: 2,
    },
    behavior: {
      aggroRange: 3,
      preferredTarget: 'nearest',
      fleeHealthPercent: 0,
      specialAbility: {
        name: 'Replicate',
        cooldown: 5,
        effect: 'replicate',
        value: 1,
      },
    },
    color: 0x4ade80, // Green
    shape: 'square',
  },
  trojan: {
    name: 'Trojan',
    description: 'Disguised as data cache; ambushes when approached',
    baseStats: {
      maxHealth: 80,
      attack: 20,
      defense: 5,
      speed: 1,
    },
    behavior: {
      aggroRange: 1,
      preferredTarget: 'weakest',
      fleeHealthPercent: 20,
      specialAbility: {
        name: 'Ambush',
        cooldown: 0,
        effect: 'entangle',
        value: 2,
      },
    },
    color: 0xfb923c, // Orange
    shape: 'triangle',
  },
  rootkit: {
    name: 'Rootkit',
    description: 'Entrenched and hard to remove; corrupts nearby tiles',
    baseStats: {
      maxHealth: 200,
      attack: 8,
      defense: 15,
      speed: 0, // Stationary
    },
    behavior: {
      aggroRange: 2,
      preferredTarget: 'nearest',
      fleeHealthPercent: 0,
      specialAbility: {
        name: 'Corrupt Ground',
        cooldown: 3,
        effect: 'corrupt_tile',
        value: 25,
      },
    },
    color: 0xa855f7, // Purple
    shape: 'hexagon',
  },
  logic_bomb: {
    name: 'Logic Bomb',
    description: 'Dormant until triggered; explodes with massive damage',
    baseStats: {
      maxHealth: 50,
      attack: 50,
      defense: 0,
      speed: 0,
    },
    behavior: {
      aggroRange: 2,
      preferredTarget: 'nearest',
      fleeHealthPercent: 0,
      specialAbility: {
        name: 'Detonate',
        cooldown: 0,
        effect: 'explode',
        value: 3, // Radius
      },
    },
    color: 0xef4444, // Red
    shape: 'diamond',
  },
}

// ============= Status =============

export type MalwareStatus =
  | 'dormant' // Not yet activated (trojans, logic bombs)
  | 'active' // Normal state
  | 'alerted' // Has detected a process
  | 'fleeing' // Running away
  | 'destroyed'

// ============= Malware Entity =============

export interface Malware {
  id: string
  type: MalwareType
  name: string

  // Stats
  stats: {
    health: number
    maxHealth: number
    attack: number
    defense: number
    speed: number
  }

  // Behavior
  behavior: MalwareBehaviorConfig
  abilityCooldown: number // Current cooldown remaining

  // Position and state
  position: GridPosition
  status: MalwareStatus
  isRevealed: boolean // False for trojans until triggered

  // Visual
  color: number
  shape: 'square' | 'triangle' | 'diamond' | 'hexagon'
}

// ============= Factory =============

let malwareIdCounter = 0

export function createMalware(
  type: MalwareType,
  position: GridPosition,
  difficultyMultiplier: number = 1
): Malware {
  const definition = MALWARE_TYPES[type]
  const id = `malware-${++malwareIdCounter}`

  const scaledMaxHealth = Math.floor(definition.baseStats.maxHealth * difficultyMultiplier)

  return {
    id,
    type,
    name: `${definition.name}-${malwareIdCounter}`,
    stats: {
      maxHealth: scaledMaxHealth,
      health: scaledMaxHealth,
      attack: Math.floor(definition.baseStats.attack * difficultyMultiplier),
      defense: Math.floor(definition.baseStats.defense * difficultyMultiplier),
      speed: definition.baseStats.speed,
    },
    behavior: { ...definition.behavior },
    abilityCooldown: 0,
    position: { ...position },
    status: type === 'trojan' || type === 'logic_bomb' ? 'dormant' : 'active',
    isRevealed: type !== 'trojan',
    color: definition.color,
    shape: definition.shape,
  }
}

// ============= Utility Functions =============

export function isMalwareAlive(malware: Malware): boolean {
  return malware.stats.health > 0 && malware.status !== 'destroyed'
}

export function getMalwareHealthPercent(malware: Malware): number {
  return (malware.stats.health / malware.stats.maxHealth) * 100
}

export function applyDamageToMalware(malware: Malware, damage: number): number {
  const actualDamage = Math.max(0, damage - malware.stats.defense)
  malware.stats.health = Math.max(0, malware.stats.health - actualDamage)

  if (malware.stats.health <= 0) {
    malware.status = 'destroyed'
  }

  return actualDamage
}

export function activateMalware(malware: Malware): void {
  if (malware.status === 'dormant') {
    malware.status = 'alerted'
    malware.isRevealed = true
  }
}

export function tickMalwareCooldown(malware: Malware): void {
  if (malware.abilityCooldown > 0) {
    malware.abilityCooldown--
  }
}

export function canUseAbility(malware: Malware): boolean {
  return (
    malware.behavior.specialAbility !== null &&
    malware.abilityCooldown === 0 &&
    isMalwareAlive(malware)
  )
}

export function useAbility(malware: Malware): void {
  if (malware.behavior.specialAbility) {
    malware.abilityCooldown = malware.behavior.specialAbility.cooldown
  }
}
